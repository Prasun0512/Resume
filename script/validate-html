#!/usr/bin/env ruby
# frozen_string_literal: true

require "w3c_validators"
require "find"

site_dir = File.expand_path("_site", __dir__)
html_files = Dir.glob(File.join(site_dir, "**/*.html"))

if html_files.empty?
  puts "No HTML files found in #{site_dir}; skipping W3C validation."
  exit 0
end

validator = W3CValidators::NuValidator.new

had_errors = false

html_files.each do |file|
  puts "Checking #{file}..."
  begin
    result = validator.validate_file(file)
    if result.errors.any?
      had_errors = true
      puts "Errors in #{file}:"
      result.errors.each { |err| puts err } # puts already stringifies
    end
  rescue StandardError => e
    had_errors = true
    warn "Validator crashed on #{file}: #{e.message}"
  end
end

exit(had_errors ? 1 : 0)
